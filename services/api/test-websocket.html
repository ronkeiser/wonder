<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket Streaming Test</title>
    <style>
      body {
        font-family: monospace;
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
        background: #1e1e1e;
        color: #d4d4d4;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        background: #0e639c;
        color: white;
        border: none;
        border-radius: 4px;
        margin-right: 10px;
      }
      button:hover {
        background: #1177bb;
      }
      #status {
        margin: 20px 0;
        padding: 10px;
        background: #2d2d2d;
        border-left: 3px solid #0e639c;
      }
      #events {
        margin-top: 20px;
        padding: 10px;
        background: #2d2d2d;
        max-height: 600px;
        overflow-y: auto;
      }
      .event {
        margin: 10px 0;
        padding: 8px;
        background: #1e1e1e;
        border-left: 3px solid #4ec9b0;
      }
      .event-kind {
        color: #4ec9b0;
        font-weight: bold;
      }
      .event-time {
        color: #858585;
        font-size: 12px;
      }
      .event-payload {
        margin-top: 5px;
        color: #ce9178;
      }
    </style>
  </head>
  <body>
    <h1>ðŸš€ WebSocket Event Streaming Test</h1>

    <div>
      <button onclick="startWorkflow()">Start Workflow</button>
      <button onclick="disconnect()">Disconnect</button>
    </div>

    <div id="status">Status: Ready</div>

    <div id="events"></div>

    <script>
      const API_BASE = 'https://wonder-api.ron-keiser.workers.dev';
      const WORKFLOW_ID = '01JDXSEED0000WORKFLOW0001';

      let ws = null;
      let workflowRunId = null;
      let doId = null;

      function setStatus(msg) {
        document.getElementById('status').textContent = 'Status: ' + msg;
      }

      function addEvent(kind, timestamp, payload) {
        const eventsDiv = document.getElementById('events');
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event';

        const time = new Date(timestamp).toLocaleTimeString();

        eventDiv.innerHTML = `
        <div class="event-kind">${kind}</div>
        <div class="event-time">${time}</div>
        <div class="event-payload">${JSON.stringify(payload, null, 2)}</div>
      `;

        eventsDiv.appendChild(eventDiv);
        eventsDiv.scrollTop = eventsDiv.scrollHeight;
      }

      async function startWorkflow() {
        try {
          setStatus('Starting workflow...');

          const response = await fetch(`${API_BASE}/workflows/start`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              workflow_id: WORKFLOW_ID,
              input: { name: 'World' },
            }),
          });

          if (!response.ok) {
            throw new Error(`Failed to start workflow: ${await response.text()}`);
          }

          const data = await response.json();
          workflowRunId = data.workflow_run_id;
          doId = data.durable_object_id;

          setStatus(`Workflow started (Run: ${workflowRunId})`);

          // Connect WebSocket
          connectWebSocket();
        } catch (err) {
          setStatus('Error: ' + err.message);
          console.error(err);
        }
      }

      function connectWebSocket() {
        const wsUrl = `${API_BASE.replace('https://', 'wss://')}/coordinator/${doId}/stream`;
        setStatus(`Connecting to WebSocket...`);

        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          setStatus('âœ… WebSocket connected - streaming events');
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          addEvent(data.kind, data.timestamp, data.payload);

          if (data.kind === 'workflow_completed') {
            setStatus('âœ… Workflow completed');
            ws.close();
          }
        };

        ws.onerror = (error) => {
          setStatus('âŒ WebSocket error');
          console.error('WebSocket error:', error);
        };

        ws.onclose = () => {
          setStatus('WebSocket closed');
        };
      }

      function disconnect() {
        if (ws) {
          ws.close();
          ws = null;
        }
        setStatus('Disconnected');
      }
    </script>
  </body>
</html>
