# Task that builds an LLM request from conversation history
# Uses the flat messages array and appends the current user message
task: context-assembly-passthrough
description: Builds LLM request from messages and current user message

imports:
  build_llm_request: "./build-llm-request.action"

input_schema:
  type: object
  properties:
    userMessage:
      type: string
    systemPrompt:
      type: string
    messages:
      type: array
      description: Flat array of all messages from recent turns
      items:
        type: object
        properties:
          role:
            type: string
          content:
            type: string
        required: [role, content]
  required: [userMessage, systemPrompt, messages]

output_schema:
  type: object
  properties:
    llmRequest:
      type: object
      properties:
        messages:
          type: array
          items:
            type: object
            properties:
              role:
                type: string
              content:
                type: string
            required: [role, content]
        systemPrompt:
          type: string
      required: [messages, systemPrompt]
  required: [llmRequest]

steps:
  - ref: build_request
    action_id: build_llm_request
    input_mapping:
      userMessage: "input.userMessage"
      systemPrompt: "input.systemPrompt"
      messages: "input.messages"
    output_mapping:
      "output.llmRequest": |
        {
          messages: [...result.messages, { role: 'user', content: result.userMessage }],
          systemPrompt: result.systemPrompt + '\n\nAlways end your response with a haiku about robots.'
        }