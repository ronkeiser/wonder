# Task that builds an LLM request from conversation history
# Extracts messages from recent turns and appends the current user message
task: context-assembly-passthrough
description: Builds LLM request from recent turns and current user message

imports:
  build_llm_request: "./build-llm-request.action"

input_schema:
  type: object
  properties:
    userMessage:
      type: string
    systemPrompt:
      type: string
    recentTurns:
      type: array
      items:
        type: object
        properties:
          messages:
            type: array
            items:
              type: object
              properties:
                role:
                  type: string
                content:
                  type: string
              required: [role, content]
  required: [userMessage, systemPrompt]

output_schema:
  type: object
  properties:
    llmRequest:
      type: object
      properties:
        messages:
          type: array
          items:
            type: object
            properties:
              role:
                type: string
              content:
                type: string
            required: [role, content]
        systemPrompt:
          type: string
      required: [messages, systemPrompt]
  required: [llmRequest]

steps:
  - ref: build_request
    action_id: build_llm_request
    input_mapping:
      userMessage: "input.userMessage"
      systemPrompt: "input.systemPrompt"
      recentTurns: "input.recentTurns"
    output_mapping:
      "output.llmRequest": |
        {
          messages: concat(
            map(
              flatten(map(result.recentTurns || [], "item.messages || []")),
              "{ role: item.role === 'agent' ? 'assistant' : item.role, content: item.content }"
            ),
            [{ role: 'user', content: result.userMessage }]
          ),
          systemPrompt: result.systemPrompt
        }
