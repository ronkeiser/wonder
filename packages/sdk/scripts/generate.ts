#!/usr/bin/env tsx
/**
 * Generate TypeScript types from OpenAPI spec with custom transform hooks.
 *
 * Transforms schema fields (input_schema, output_schema, context_schema)
 * from Record<string, any> to SchemaType imported from @wonder/context.
 */

import { writeFile } from 'node:fs/promises';
import openapiTS from 'openapi-typescript';
import ts from 'typescript';

const API_URL = process.env.API_URL || 'https://wonder-http.ron-keiser.workers.dev';

async function generate() {
  console.log(`Fetching OpenAPI spec from ${API_URL}/doc...`);

  const ast = await openapiTS(`${API_URL}/doc`, {
    transform(schemaObject, options) {
      const path = options.path || '';

      // Intercept schema fields and replace with SchemaType reference
      if (
        path.endsWith('input_schema') ||
        path.endsWith('output_schema') ||
        path.endsWith('context_schema')
      ) {
        return ts.factory.createTypeReferenceNode('SchemaType');
      }

      // Use default transformation for everything else
      return undefined;
    },
  });

  // Add import statement for SchemaType
  const importStatement = ts.factory.createImportDeclaration(
    undefined, // modifiers
    ts.factory.createImportClause(
      true, // isTypeOnly
      undefined, // name
      ts.factory.createNamedImports([
        ts.factory.createImportSpecifier(
          false, // isTypeOnly
          undefined, // propertyName
          ts.factory.createIdentifier('SchemaType'),
        ),
      ]),
    ),
    ts.factory.createStringLiteral('@wonder/context'),
    undefined, // attributes
  );

  // Combine import + generated AST
  const printer = ts.createPrinter({ newLine: ts.NewLineKind.LineFeed });
  const sourceFile = ts.createSourceFile(
    'schema.d.ts',
    '',
    ts.ScriptTarget.Latest,
    false,
    ts.ScriptKind.TS,
  );

  // Print import statement
  const importCode = printer.printNode(ts.EmitHint.Unspecified, importStatement, sourceFile);

  // Print generated types
  const typesCode = ast
    .map((node) => printer.printNode(ts.EmitHint.Unspecified, node, sourceFile))
    .join('\n\n');

  const header = `/**
 * This file was auto-generated by openapi-typescript.
 * Do not make direct changes to the file.
 */

`;

  const output = header + importCode + '\n\n' + typesCode;

  // Write to file
  const outputPath = 'src/generated/schema.d.ts';
  await writeFile(outputPath, output, 'utf-8');

  console.log(`âœ“ Generated types written to ${outputPath}`);
}

generate().catch((err) => {
  console.error('Generation failed:', err);
  process.exit(1);
});
